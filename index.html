<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Neko Day üê±</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Fredoka+One&display=swap');
:root{
  --pink:#f48fb1;--lavender:#ce93d8;--peach:#ffcc80;--mint:#b2dfdb;
  --text:#5d4037;--shadow:rgba(180,100,140,0.22);
  --W:420px;--H:700px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{
  width:100%;height:100%;height:100dvh;
  font-family:'Nunito',sans-serif;
  background:#1a0a2e;
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;user-select:none;overscroll-behavior:none;
}
#app{
  width:min(420px,100vw);
  height:min(700px,100dvh);
  position:relative;overflow:hidden;
  background:#fff9f0;
  border-radius:clamp(0px,3vw,24px);
  box-shadow:0 0 80px rgba(244,143,177,0.4),0 0 0 1px rgba(255,255,255,0.1);
}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen{
  position:absolute;inset:0;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  gap:14px;padding:20px 18px;
  overflow-y:auto;
  transition:opacity 0.3s;
}
.screen.hidden{display:none;}

/* ‚îÄ‚îÄ TITLE ‚îÄ‚îÄ */
#title-screen{
  background:linear-gradient(170deg,#fde8f5 0%,#f3e5f5 40%,#e8f5e9 100%);
}
.title-logo{
  font-family:'Fredoka One',cursive;
  font-size:52px;color:var(--text);
  text-shadow:3px 3px 0 var(--pink),6px 6px 0 rgba(244,143,177,.25);
  letter-spacing:2px;text-align:center;
  animation:titleBounce 2.2s ease-in-out infinite;
}
.title-sub{font-size:14px;color:#a0887a;font-weight:700;text-align:center;line-height:1.7;}
#title-cat-preview{
  width:140px;height:140px;
  border-radius:50%;
  background:white;
  box-shadow:0 8px 32px var(--shadow),0 0 0 4px rgba(244,143,177,0.2);
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
}
#title-cat-preview canvas{display:block;}

/* ‚îÄ‚îÄ CUSTOM ‚îÄ‚îÄ */
#custom-screen{
  background:linear-gradient(170deg,#e8f5e9 0%,#f3e5f5 60%,#fde8f5 100%);
  justify-content:flex-start;padding-top:16px;
  gap:10px;
}
#custom-screen h2{
  font-family:'Fredoka One',cursive;
  font-size:28px;color:var(--text);
  text-shadow:2px 2px 0 var(--pink);
  margin-top:4px;
}
.custom-section{width:100%;max-width:360px;}
.custom-label{
  font-size:12px;font-weight:900;color:#b06090;
  text-transform:uppercase;letter-spacing:1px;
  margin-bottom:6px;display:block;
}
.swatch-row{display:flex;gap:7px;flex-wrap:wrap;}
.swatch{
  width:36px;height:36px;border-radius:50%;
  border:3px solid transparent;cursor:pointer;
  transition:transform .12s,border-color .12s;
  touch-action:manipulation;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
}
.swatch.selected{border-color:#5d4037;transform:scale(1.2);}
.swatch:active{transform:scale(0.9);}
.option-row{display:flex;gap:7px;flex-wrap:wrap;}
.opt-btn{
  padding:6px 12px;border-radius:20px;
  border:2.5px solid transparent;
  background:white;cursor:pointer;
  font-family:'Nunito',sans-serif;font-size:12px;font-weight:900;
  color:var(--text);box-shadow:0 2px 8px var(--shadow);
  transition:all .12s;touch-action:manipulation;
}
.opt-btn.selected{border-color:var(--pink);background:#fce4ec;color:#ad1457;}
.opt-btn:active{transform:scale(0.93);}

/* cat preview card */
#custom-preview-wrap{
  display:flex;flex-direction:column;align-items:center;gap:6px;
}
#preview-canvas-wrap{
  width:100px;height:100px;border-radius:50%;
  background:white;box-shadow:0 4px 18px var(--shadow),0 0 0 3px rgba(244,143,177,0.3);
  display:flex;align-items:center;justify-content:center;overflow:hidden;
}
#cat-name-input{
  padding:8px 18px;border-radius:30px;
  border:2.5px solid #f8bbd0;
  font-family:'Nunito',sans-serif;font-size:15px;font-weight:700;
  color:var(--text);background:white;text-align:center;outline:none;
  width:180px;box-shadow:0 2px 8px var(--shadow);
}
#cat-name-input:focus{border-color:var(--pink);}

/* ‚îÄ‚îÄ DIFF SELECT ‚îÄ‚îÄ */
#diff-screen{
  background:linear-gradient(170deg,#fff9f0 0%,#fce4ec 100%);
}
#diff-screen h2{
  font-family:'Fredoka One',cursive;font-size:28px;
  color:var(--text);text-shadow:2px 2px 0 var(--peach);
}
.diff-cards{display:flex;flex-direction:column;gap:10px;width:100%;max-width:340px;}
.diff-card{
  background:white;border-radius:18px;padding:14px 18px;
  border:3px solid transparent;cursor:pointer;
  display:flex;align-items:center;gap:14px;
  box-shadow:0 4px 14px var(--shadow);
  transition:all .15s;touch-action:manipulation;
}
.diff-card:active{transform:scale(0.97);}
.diff-card.selected{border-color:var(--pink);background:#fce4ec;}
.diff-card.selected.easy{border-color:#66bb6a;background:#f1f8e9;}
.diff-card.selected.hard{border-color:#ff7043;background:#fbe9e7;}
.diff-card.selected.paws{border-color:#7e57c2;background:#ede7f6;}
.diff-icon-big{font-size:32px;flex-shrink:0;}
.diff-card-text{}
.diff-card-name{font-size:16px;font-weight:900;color:var(--text);}
.diff-card-desc{font-size:11px;font-weight:700;color:#a0887a;margin-top:2px;}

/* ‚îÄ‚îÄ LEVEL SELECT ‚îÄ‚îÄ */
#level-screen{
  background:linear-gradient(170deg,#fff9f0 0%,#fce4ec 60%,#f3e5f5 100%);
}
#level-screen h2{
  font-family:'Fredoka One',cursive;font-size:28px;
  color:var(--text);text-shadow:2px 2px 0 var(--peach);
}
.level-list{display:flex;flex-direction:column;gap:10px;width:100%;max-width:340px;}
.level-card{
  background:white;border-radius:18px;padding:14px 18px;
  border:3px solid transparent;cursor:pointer;
  display:flex;align-items:center;gap:14px;
  box-shadow:0 4px 14px var(--shadow);
  transition:all .15s;touch-action:manipulation;
}
.level-card.unlocked{border-color:var(--pink);}
.level-card.locked{opacity:.5;cursor:not-allowed;filter:grayscale(.5);}
.level-card:active:not(.locked){transform:scale(0.97);}
.level-icon{font-size:32px;flex-shrink:0;}
.level-card-text{}
.level-card-name{font-size:15px;font-weight:900;color:var(--text);}
.level-card-desc{font-size:11px;font-weight:700;color:#a0887a;margin-top:2px;}

/* ‚îÄ‚îÄ GAME OVER / COMPLETE ‚îÄ‚îÄ */
#gameover-screen{background:rgba(253,232,245,.97);}
#levelcomplete-screen{background:rgba(240,255,244,.97);}
#gameover-screen h2,#levelcomplete-screen h2{
  font-family:'Fredoka One',cursive;font-size:36px;
  color:var(--text);text-align:center;
}
.result-emoji{font-size:72px;animation:titleBounce 1.5s ease-in-out infinite;}
.result-score{font-size:22px;font-weight:900;color:var(--text);}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{
  background:linear-gradient(135deg,var(--pink),var(--lavender));
  color:white;border:none;
  padding:12px 36px;border-radius:50px;
  font-family:'Fredoka One',cursive;font-size:18px;
  cursor:pointer;
  box-shadow:0 5px 0 #b06090,0 8px 18px rgba(200,100,150,.3);
  transition:transform .1s,box-shadow .1s;touch-action:manipulation;
}
.btn:active{transform:translateY(3px);box-shadow:0 2px 0 #b06090;}
.btn-green{background:linear-gradient(135deg,#66bb6a,#26a69a);box-shadow:0 5px 0 #2e7d32,0 8px 16px rgba(50,150,80,.3);}
.btn-green:active{box-shadow:0 2px 0 #2e7d32;}
.btn-sm{font-size:14px;padding:9px 24px;}
.btn-grey{background:linear-gradient(135deg,#ce93d8,#b0bec5);box-shadow:0 5px 0 #7b6080;}
.btn-grey:active{box-shadow:0 2px 0 #7b6080;}
.btn-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;}

/* ‚îÄ‚îÄ HUD ‚îÄ‚îÄ */
#hud{
  position:absolute;top:0;left:0;right:0;
  display:none;
  padding:6px 10px 4px;
  background:linear-gradient(180deg,rgba(255,249,240,0.95),rgba(255,249,240,0));
  z-index:20;pointer-events:none;
}
.hud-row{display:flex;align-items:center;gap:6px;}
.hud-pill{
  background:rgba(255,255,255,0.88);
  backdrop-filter:blur(4px);
  border-radius:20px;padding:3px 10px;
  display:flex;align-items:center;gap:5px;
  box-shadow:0 2px 8px var(--shadow);
  font-size:11px;font-weight:700;color:var(--text);
}
.hud-pill.energy{flex:1;}
.energy-bar-bg{flex:1;height:8px;background:#fce4ec;border-radius:6px;overflow:hidden;min-width:40px;}
#energy-bar{height:100%;border-radius:6px;transition:width .3s,background .3s;background:linear-gradient(90deg,#f48fb1,#f06292);}
#score-val{font-size:13px;font-weight:900;color:var(--text);}
#key-indicator{font-size:14px;}
#diff-badge-hud{font-size:10px;font-weight:900;padding:2px 7px;border-radius:12px;}
#diff-badge-hud.easy{background:#c8e6c9;color:#2e7d32;}
#diff-badge-hud.normal{background:#fce4ec;color:#ad1457;}
#diff-badge-hud.hard{background:#ffe0b2;color:#e65100;}
#diff-badge-hud.paws{background:#ede7f6;color:#4527a0;}

/* ‚îÄ‚îÄ GAME CANVAS ‚îÄ‚îÄ */
#game-canvas-wrap{
  position:absolute;inset:0;
  display:none;
}
#gameCanvas{display:block;width:100%;height:100%;}

/* ‚îÄ‚îÄ TOUCH CONTROLS ‚îÄ‚îÄ */
#touch-controls{
  position:absolute;bottom:0;left:0;right:0;
  display:none;
  padding:12px 16px 20px;
  justify-content:space-between;align-items:flex-end;
  pointer-events:none;
  z-index:25;
}
#joystick-zone{
  width:110px;height:110px;
  border-radius:50%;
  background:rgba(255,255,255,0.25);
  backdrop-filter:blur(6px);
  border:2px solid rgba(255,255,255,0.4);
  position:relative;pointer-events:auto;
  touch-action:none;
}
#joystick-knob{
  position:absolute;
  width:46px;height:46px;border-radius:50%;
  background:rgba(255,255,255,0.75);
  border:2.5px solid rgba(244,143,177,0.8);
  box-shadow:0 3px 10px rgba(180,100,140,.3);
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  transition:transform 0.05s;
  pointer-events:none;
}
.action-btns{display:flex;flex-direction:column;gap:10px;align-items:flex-end;pointer-events:auto;}
.touch-action-btn{
  width:64px;height:64px;border-radius:50%;
  background:rgba(255,255,255,0.65);
  backdrop-filter:blur(6px);
  border:2.5px solid rgba(244,143,177,0.6);
  box-shadow:0 3px 12px rgba(180,100,140,.25);
  display:flex;align-items:center;justify-content:center;
  font-size:22px;cursor:pointer;touch-action:manipulation;
  user-select:none;-webkit-user-select:none;
  transition:transform .08s,background .1s;
  pointer-events:auto;
}
.touch-action-btn.pressed{background:rgba(244,143,177,0.5);transform:scale(0.88);}
#jump-btn{
  background:linear-gradient(135deg,rgba(244,143,177,0.7),rgba(206,147,216,0.7));
  border-color:rgba(244,143,177,0.9);width:72px;height:72px;font-size:26px;
}

/* ‚îÄ‚îÄ POPUP SCORES ‚îÄ‚îÄ */
.pop{
  position:absolute;pointer-events:none;z-index:30;
  font-size:16px;font-weight:900;
  font-family:'Nunito',sans-serif;color:var(--text);
  animation:popUp 1.1s ease-out forwards;
  white-space:nowrap;
}
@keyframes popUp{0%{transform:translateY(0) scale(.7);opacity:1;}100%{transform:translateY(-60px) scale(1.1);opacity:0;}}
@keyframes titleBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
@keyframes doorShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-5px)}40%{transform:translateX(5px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
@keyframes keyPulse{0%,100%{filter:drop-shadow(0 0 4px #ffd700)}50%{filter:drop-shadow(0 0 12px #ffd700) drop-shadow(0 0 4px #ff8c00)}}

@media(pointer:coarse){#touch-controls{display:flex;}}
@media(min-width:421px){
  #app{box-shadow:0 0 100px rgba(244,143,177,0.5),0 0 0 1px rgba(255,255,255,0.08);}
}
</style>
</head>
<body>
<div id="app">

<!-- TITLE -->
<div class="screen" id="title-screen">
  <div id="title-cat-preview"><canvas id="titleCatCanvas" width="130" height="130"></canvas></div>
  <div class="title-logo">Neko Day ‚ú®</div>
  <div class="title-sub">A cozy top-down cat adventure!<br>Find the üóùÔ∏è key ¬∑ scratch üêæ dogs away ¬∑ collect treats</div>
  <button class="btn" onclick="showScreen('custom-screen')">Customize Your Cat üê±</button>
  <button class="btn btn-grey btn-sm" style="margin-top:-4px" onclick="quickPlay()">Quick Play ‚Üí</button>
</div>

<!-- CUSTOMISE -->
<div class="screen hidden" id="custom-screen">
  <h2>Your Cat ‚ú®</h2>
  <div id="custom-preview-wrap">
    <div id="preview-canvas-wrap"><canvas id="previewCanvas" width="90" height="90"></canvas></div>
    <input class="name-box" id="cat-name-input" placeholder="Mochi" maxlength="14" value="Mochi" oninput="updatePreview()"/>
  </div>

  <div class="custom-section">
    <span class="custom-label">üé® Fur Color</span>
    <div class="swatch-row" id="color-swatches">
      <div class="swatch selected" data-idx="0" style="background:#fff9f0;border:2px solid #ddd" onclick="setCatProp('colorIdx',0)"></div>
      <div class="swatch" data-idx="1" style="background:#ffb74d" onclick="setCatProp('colorIdx',1)"></div>
      <div class="swatch" data-idx="2" style="background:#9e9e9e" onclick="setCatProp('colorIdx',2)"></div>
      <div class="swatch" data-idx="3" style="background:#424242" onclick="setCatProp('colorIdx',3)"></div>
      <div class="swatch" data-idx="4" style="background:#ffcc80" onclick="setCatProp('colorIdx',4)"></div>
      <div class="swatch" data-idx="5" style="background:#a1887f" onclick="setCatProp('colorIdx',5)"></div>
      <div class="swatch" data-idx="6" style="background:#f8bbd0" onclick="setCatProp('colorIdx',6)"></div>
    </div>
  </div>

  <div class="custom-section">
    <span class="custom-label">üêæ Pattern</span>
    <div class="option-row" id="pattern-opts">
      <div class="opt-btn selected" data-val="solid" onclick="setCatProp('pattern','solid')">Solid</div>
      <div class="opt-btn" data-val="tabby" onclick="setCatProp('pattern','tabby')">Tabby</div>
      <div class="opt-btn" data-val="spots" onclick="setCatProp('pattern','spots')">Spotty</div>
      <div class="opt-btn" data-val="tuxedo" onclick="setCatProp('pattern','tuxedo')">Tuxedo</div>
      <div class="opt-btn" data-val="calico" onclick="setCatProp('pattern','calico')">Calico</div>
    </div>
  </div>

  <div class="custom-section">
    <span class="custom-label">üëÅÔ∏è Eye Color</span>
    <div class="swatch-row" id="eye-swatches">
      <div class="swatch selected" data-idx="0" style="background:#4caf50" onclick="setCatProp('eyeIdx',0)"></div>
      <div class="swatch" data-idx="1" style="background:#2196f3" onclick="setCatProp('eyeIdx',1)"></div>
      <div class="swatch" data-idx="2" style="background:#ff9800" onclick="setCatProp('eyeIdx',2)"></div>
      <div class="swatch" data-idx="3" style="background:#9c27b0" onclick="setCatProp('eyeIdx',3)"></div>
      <div class="swatch" data-idx="4" style="background:linear-gradient(135deg,#2196f3,#ff9800)" onclick="setCatProp('eyeIdx',4)"></div>
    </div>
  </div>

  <div class="custom-section">
    <span class="custom-label">üéÄ Accessory</span>
    <div class="option-row" id="acc-opts">
      <div class="opt-btn selected" data-val="none" onclick="setCatProp('accessory','none')">None</div>
      <div class="opt-btn" data-val="bow" onclick="setCatProp('accessory','bow')">üéÄ Bow</div>
      <div class="opt-btn" data-val="flower" onclick="setCatProp('accessory','flower')">üå∏ Flower</div>
      <div class="opt-btn" data-val="hat" onclick="setCatProp('accessory','hat')">üé© Hat</div>
      <div class="opt-btn" data-val="stars" onclick="setCatProp('accessory','stars')">‚≠ê Stars</div>
      <div class="opt-btn" data-val="crown" onclick="setCatProp('accessory','crown')">üëë Crown</div>
    </div>
  </div>

  <div class="btn-row">
    <button class="btn btn-grey btn-sm" onclick="showScreen('title-screen')">‚Üê Back</button>
    <button class="btn btn-sm" onclick="showScreen('diff-screen')">Next ‚Üí</button>
  </div>
</div>

<!-- DIFFICULTY -->
<div class="screen hidden" id="diff-screen">
  <h2>Difficulty üéÆ</h2>
  <div class="diff-cards">
    <div class="diff-card easy selected" data-diff="easy" onclick="selectDiff('easy')">
      <div class="diff-icon-big">üå∏</div>
      <div class="diff-card-text">
        <div class="diff-card-name">Easy</div>
        <div class="diff-card-desc">Slow lazy dogs ¬∑ gentle energy drain ¬∑ cozy vibes</div>
      </div>
    </div>
    <div class="diff-card normal" data-diff="normal" onclick="selectDiff('normal')">
      <div class="diff-icon-big">‚≠ê</div>
      <div class="diff-card-text">
        <div class="diff-card-name">Normal</div>
        <div class="diff-card-desc">Balanced fun ¬∑ dogs patrol normally</div>
      </div>
    </div>
    <div class="diff-card hard" data-diff="hard" onclick="selectDiff('hard')">
      <div class="diff-icon-big">üî•</div>
      <div class="diff-card-text">
        <div class="diff-card-name">Hard</div>
        <div class="diff-card-desc">Frisky dogs ¬∑ faster drain ¬∑ bring snacks!</div>
      </div>
    </div>
    <div class="diff-card paws" data-diff="paws" onclick="selectDiff('paws')">
      <div class="diff-icon-big">üêæ</div>
      <div class="diff-card-text">
        <div class="diff-card-name">Paws of Fury</div>
        <div class="diff-card-desc">Maximum chaos ¬∑ for brave cats only</div>
      </div>
    </div>
  </div>
  <div class="btn-row">
    <button class="btn btn-grey btn-sm" onclick="showScreen('custom-screen')">‚Üê Back</button>
    <button class="btn btn-sm" onclick="goLevelSelect()">Choose Level ‚Üí</button>
  </div>
</div>

<!-- LEVEL SELECT -->
<div class="screen hidden" id="level-screen">
  <h2>Choose Adventure üó∫Ô∏è</h2>
  <div class="level-list" id="level-list">
    <div class="level-card unlocked" id="lc-0" onclick="beginLevel(0)">
      <div class="level-icon">üè†</div>
      <div class="level-card-text">
        <div class="level-card-name">Home Sweet Home</div>
        <div class="level-card-desc">Cosy rooms ¬∑ furniture to jump ¬∑ find the key!</div>
      </div>
    </div>
    <div class="level-card locked" id="lc-1">
      <div class="level-icon">üå≥</div>
      <div class="level-card-text">
        <div class="level-card-name">Neighbourhood Park</div>
        <div class="level-card-desc">Grassy paths ¬∑ benches ¬∑ pond to navigate</div>
      </div>
    </div>
    <div class="level-card locked" id="lc-2">
      <div class="level-icon">üè¢</div>
      <div class="level-card-text">
        <div class="level-card-name">The Big Building</div>
        <div class="level-card-desc">Office floors ¬∑ rooftop escape</div>
      </div>
    </div>
    <div class="level-card locked" id="lc-3">
      <div class="level-icon">üöâ</div>
      <div class="level-card-text">
        <div class="level-card-name">Train Station</div>
        <div class="level-card-desc">Platform rush ¬∑ dodge luggage ¬∑ catch the train!</div>
      </div>
    </div>
  </div>
  <button class="btn btn-grey btn-sm" onclick="showScreen('diff-screen')">‚Üê Back</button>
</div>

<!-- GAME OVER -->
<div class="screen hidden" id="gameover-screen">
  <div class="result-emoji">üòø</div>
  <h2>Nap Time‚Ä¶</h2>
  <div id="go-name" style="font-size:15px;color:#8d6e63;font-weight:700;text-align:center"></div>
  <div id="go-score" class="result-score"></div>
  <div class="btn-row">
    <button class="btn btn-sm" onclick="retryLevel()">Try Again üå∏</button>
    <button class="btn btn-grey btn-sm" onclick="goLevelSelect()">Levels</button>
  </div>
</div>

<!-- LEVEL COMPLETE -->
<div class="screen hidden" id="levelcomplete-screen">
  <div class="result-emoji" id="lc-emoji">üéâ</div>
  <h2 id="lc-title">Level Complete!</h2>
  <div id="lc-desc" style="font-size:14px;color:#5d4037;font-weight:700;text-align:center;max-width:280px"></div>
  <div id="lc-score" class="result-score"></div>
  <div class="btn-row">
    <button class="btn btn-green btn-sm" id="lc-next-btn" onclick="nextLevel()">Next Level ‚Üí</button>
    <button class="btn btn-grey btn-sm" onclick="goLevelSelect()">Levels</button>
  </div>
</div>

<!-- HUD -->
<div id="hud">
  <div class="hud-row">
    <div class="hud-pill energy">
      <span style="font-size:13px">üç£</span>
      <div class="energy-bar-bg"><div id="energy-bar"></div></div>
    </div>
    <div class="hud-pill">‚≠ê <span id="score-val">0</span></div>
    <div class="hud-pill"><span id="key-indicator">üîë ‚úó</span></div>
    <div class="hud-pill"><span id="diff-badge-hud" class="normal">‚≠ê</span></div>
  </div>
</div>

<!-- CANVAS -->
<div id="game-canvas-wrap">
  <canvas id="gameCanvas" width="420" height="700"></canvas>
  <!-- TOUCH -->
  <div id="touch-controls">
    <div id="joystick-zone"><div id="joystick-knob"></div></div>
    <div class="action-btns">
      <div class="touch-action-btn" id="jump-btn" ontouchstart="onJumpDown(event)" ontouchend="onJumpUp(event)" style="font-size:13px;font-weight:900;font-family:'Nunito',sans-serif;line-height:1.2;text-align:center;">üêæ<br><span style="font-size:10px">SCRATCH</span></div>
    </div>
  </div>
</div>

<!-- POPUP CONTAINER -->
<div id="popup-layer" style="position:absolute;inset:0;pointer-events:none;z-index:30;overflow:hidden;"></div>

</div><!-- #app -->
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS & CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CW = 420, CH = 700;       // canvas pixels
const TILE = 42;                 // world tile size
const COLS = 10;                 // world width in tiles
const CAT_SPEED = 2.0;
const ENERGY_TICK = 130;        // frames per energy tick
const SCRATCH_RANGE = 55;       // px radius
const SCRATCH_COOLDOWN = 38;    // frames (~0.65s)
const SCRATCH_DURATION = 22;    // frames of anim

const DIFF = {
  easy:   {energyRate:0.55, dogSpeed:0.55, dogDrain:10, scratchCost:14},
  normal: {energyRate:1.0,  dogSpeed:0.85, dogDrain:16, scratchCost:18},
  hard:   {energyRate:1.6,  dogSpeed:1.3,  dogDrain:22, scratchCost:22},
  paws:   {energyRate:2.4,  dogSpeed:1.9,  dogDrain:30, scratchCost:28},
};

// ‚îÄ‚îÄ Cat appearance ‚îÄ‚îÄ
const CAT_COLORS = [
  {body:'#fff9f0',dark:'#ffe0cc',stroke:'#ffb3a0'},  // 0 cream
  {body:'#ffb74d',dark:'#e65100',stroke:'#bf360c'},  // 1 orange
  {body:'#bdbdbd',dark:'#757575',stroke:'#616161'},  // 2 grey
  {body:'#424242',dark:'#212121',stroke:'#1a1a1a'},  // 3 black
  {body:'#ffcc80',dark:'#ffa000',stroke:'#ff8f00'},  // 4 golden
  {body:'#bcaaa4',dark:'#795548',stroke:'#6d4c41'},  // 5 brown
  {body:'#f8bbd0',dark:'#f48fb1',stroke:'#e91e63'},  // 6 pink
];
const EYE_COLORS = ['#43a047','#1e88e5','#fb8c00','#8e24aa','het'];
const ACCESSORIES = ['none','bow','flower','hat','stars','crown'];

let catCfg = {colorIdx:0, pattern:'solid', eyeIdx:0, accessory:'none'};
let catName = 'Mochi';
let difficulty = 'easy';
let currentLevel = 0;
let unlockedLevels = 1;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRAW CAT (top-down, cute)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawCatTopDown(ctx, x, y, cfg, t=0, zOff=0, facingAngle=0, moving=false, scratching=false) {
  const col = CAT_COLORS[cfg.colorIdx];
  const eyeCol = cfg.eyeIdx === 4 ? null : EYE_COLORS[cfg.eyeIdx];
  const bobY = moving ? Math.sin(t*0.28)*1.5 : 0;

  ctx.save();
  ctx.translate(x, y + bobY - zOff);

  // Shadow (on ground when airborne)
  if (zOff > 0) {
    ctx.save();
    ctx.globalAlpha = Math.max(0.05, 0.3 - zOff/80);
    ctx.fillStyle = 'rgba(0,0,0,0.35)';
    ctx.beginPath(); ctx.ellipse(0, zOff*0.6, 12, 6, 0, 0, Math.PI*2); ctx.fill();
    ctx.restore();
  }

  ctx.rotate(facingAngle);

  // Tail
  const tailWag = Math.sin(t*0.12)*18;
  ctx.save();
  ctx.strokeStyle = col.body; ctx.lineWidth=7; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(0,10); ctx.quadraticCurveTo(16+tailWag,24,10+tailWag,36); ctx.stroke();
  ctx.strokeStyle=col.stroke; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(0,10); ctx.quadraticCurveTo(16+tailWag,24,10+tailWag,36); ctx.stroke();
  ctx.restore();

  // Body
  ctx.fillStyle = col.body; ctx.strokeStyle = col.stroke; ctx.lineWidth=2.5;
  ctx.beginPath(); ctx.ellipse(0,4,13,16,0,0,Math.PI*2); ctx.fill(); ctx.stroke();

  // Pattern overlay
  if (cfg.pattern === 'tabby') {
    ctx.save(); ctx.globalAlpha=0.35; ctx.fillStyle=col.dark;
    ctx.fillRect(-5,0,4,10); ctx.fillRect(1,-4,4,8); ctx.fillRect(-3,8,6,5);
    ctx.restore();
  } else if (cfg.pattern === 'spots') {
    ctx.save(); ctx.globalAlpha=0.4; ctx.fillStyle=col.dark;
    ctx.beginPath(); ctx.arc(-5,2,4,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(4,10,3,0,Math.PI*2); ctx.fill();
    ctx.restore();
  } else if (cfg.pattern === 'tuxedo') {
    ctx.save(); ctx.fillStyle='white';
    ctx.beginPath(); ctx.ellipse(0,7,6,9,0,0,Math.PI*2); ctx.fill(); ctx.restore();
  } else if (cfg.pattern === 'calico') {
    ctx.save(); ctx.globalAlpha=0.5;
    ctx.fillStyle='#e65100'; ctx.beginPath(); ctx.arc(-5,0,5,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#212121'; ctx.beginPath(); ctx.arc(4,8,4,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }

  // Head
  ctx.fillStyle=col.body; ctx.strokeStyle=col.stroke; ctx.lineWidth=2.5;
  ctx.beginPath(); ctx.arc(0,-12,13,0,Math.PI*2); ctx.fill(); ctx.stroke();

  // Ears
  ctx.fillStyle=col.body; ctx.strokeStyle=col.stroke; ctx.lineWidth=2;
  [[-8,-22],[ 8,-22]].forEach(([ex,ey])=>{
    ctx.beginPath(); ctx.moveTo(ex,ey); ctx.lineTo(ex-5,ey-9); ctx.lineTo(ex+5,ey-9); ctx.closePath(); ctx.fill(); ctx.stroke();
  });
  // inner ear
  ctx.fillStyle='#f8bbd0';
  [[-8,-22],[ 8,-22]].forEach(([ex,ey])=>{
    ctx.beginPath(); ctx.moveTo(ex,ey-1); ctx.lineTo(ex-3,ey-7); ctx.lineTo(ex+3,ey-7); ctx.closePath(); ctx.fill();
  });

  // Eyes
  const blink = (Math.floor(t*0.025)%45===0);
  const eyeH = blink ? 1 : 4.5;
  const eyePositions = [[-5,-13],[5,-13]];
  eyePositions.forEach(([ex,ey],i)=>{
    if (cfg.eyeIdx === 4) {
      ctx.fillStyle = i===0 ? '#1e88e5':'#fb8c00';
    } else {
      ctx.fillStyle = eyeCol;
    }
    ctx.beginPath(); ctx.ellipse(ex,ey,3.5,eyeH,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='white';
    ctx.beginPath(); ctx.arc(ex+1,ey-1,1.2,0,Math.PI*2); ctx.fill();
  });

  // Nose
  ctx.fillStyle='#f48fb1';
  ctx.beginPath(); ctx.arc(0,-9,2.5,0,Math.PI*2); ctx.fill();
  // Mouth
  ctx.strokeStyle='#f48fb1'; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.moveTo(0,-7); ctx.lineTo(-3,-5); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(0,-7); ctx.lineTo(3,-5); ctx.stroke();
  // Whiskers
  ctx.strokeStyle='rgba(150,120,110,0.5)'; ctx.lineWidth=1;
  [[-14,-10],[-18,-9],[-14,-8]].forEach(([wx,wy])=>{ctx.beginPath();ctx.moveTo(-2,-9);ctx.lineTo(wx,wy);ctx.stroke();});
  [[14,-10],[18,-9],[14,-8]].forEach(([wx,wy])=>{ctx.beginPath();ctx.moveTo(2,-9);ctx.lineTo(wx,wy);ctx.stroke();});
  // Blush
  ctx.fillStyle='rgba(255,140,140,0.2)';
  ctx.beginPath(); ctx.ellipse(-7,-11,4,2.5,0,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(7,-11,4,2.5,0,0,Math.PI*2); ctx.fill();

  // Claws when scratching
  if(scratching){
    ctx.strokeStyle='#bbb'; ctx.lineWidth=1.5; ctx.lineCap='round';
    // front paw claws radiating outward
    [[-14,6],[-16,10],[-13,13],[14,6],[16,10],[13,13]].forEach(([cx,cy])=>{
      ctx.beginPath(); ctx.moveTo(cx*0.5,cy*0.5); ctx.lineTo(cx,cy); ctx.stroke();
    });
    // Angry eyes ‚Äî narrow
    ctx.fillStyle='rgba(0,0,0,0.25)';
    ctx.beginPath(); ctx.ellipse(-5,-13,3.5,1.5,-0.3,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(5,-13,3.5,1.5,0.3,0,Math.PI*2); ctx.fill();
  }

  // Accessory
  drawAccessory(ctx, cfg.accessory, t);

  ctx.restore();
}

function drawScratchEffect(cat, t){
  const progress = cat.scratchTimer / SCRATCH_DURATION; // 1‚Üí0
  // Two-phase: burst (progress>0.5) then fade (progress<0.5)
  const burstP = Math.min(1, progress * 2);          // 1‚Üí0 in first half
  const fadeP  = Math.max(0, progress * 2 - 1);      // 1‚Üí0 in second half
  const spread = (1 - burstP) * SCRATCH_RANGE * 1.4; // expands outward fast

  ctx.save();
  ctx.translate(cat.wx, cat.wy);
  ctx.rotate(cat.facingAngle);

  // ‚îÄ‚îÄ Flash ring at moment of scratch ‚îÄ‚îÄ
  if(burstP > 0.6){
    const flashAlpha = (burstP - 0.6) / 0.4;
    ctx.save();
    ctx.globalAlpha = flashAlpha * 0.55;
    ctx.fillStyle = '#ff6b9d';
    ctx.beginPath(); ctx.arc(0,0,28,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }

  // ‚îÄ‚îÄ Five bold claw slashes fanning out ‚îÄ‚îÄ
  const slashAngles = [-0.75, -0.35, 0, 0.35, 0.75];
  const colors      = ['#ff1a6e','#ff4d8d','#ff80aa','#ff4d8d','#ff1a6e'];
  const widths      = [6, 5, 7, 5, 6];
  slashAngles.forEach((angle, i) => {
    ctx.save();
    ctx.rotate(angle);
    const r1 = 10 + spread * 0.25;
    const r2 = 22 + spread * 1.05;
    const a  = i === 2 ? progress : progress * 0.85; // centre slash stays brightest
    ctx.globalAlpha = Math.min(1, a * 1.1);
    // White core
    ctx.strokeStyle = 'white';
    ctx.lineWidth = widths[i] + 2;
    ctx.lineCap = 'round';
    ctx.beginPath(); ctx.moveTo(0, -r1); ctx.lineTo(0, -r2); ctx.stroke();
    // Coloured slash
    ctx.strokeStyle = colors[i];
    ctx.lineWidth = widths[i];
    ctx.beginPath(); ctx.moveTo(0, -r1); ctx.lineTo(0, -r2); ctx.stroke();
    // Claw tip ‚Äî bright teardrop
    ctx.fillStyle = 'white';
    ctx.beginPath(); ctx.arc(0, -r2, 5, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = colors[i];
    ctx.beginPath(); ctx.arc(0, -r2, 3.5, 0, Math.PI*2); ctx.fill();
    ctx.restore();
  });

  // ‚îÄ‚îÄ Expanding shockwave rings (two of them) ‚îÄ‚îÄ
  [0.9, 0.65].forEach((phase, ri) => {
    const ringSpread = spread * phase + 12;
    const ringAlpha  = progress * (1 - ri * 0.3);
    ctx.globalAlpha = ringAlpha * 0.75;
    ctx.strokeStyle = ri === 0 ? '#ff1a6e' : 'white';
    ctx.lineWidth = ri === 0 ? 3.5 : 2;
    ctx.beginPath(); ctx.arc(0, 0, ringSpread, 0, Math.PI*2); ctx.stroke();
  });

  // ‚îÄ‚îÄ Starburst impact particles ‚îÄ‚îÄ
  const numStars = 8;
  for(let i = 0; i < numStars; i++){
    const a = (i / numStars) * Math.PI * 2;
    const r = spread * 0.7 + 8;
    const sa = 0.8 + Math.sin(i * 1.3) * 0.3;
    ctx.globalAlpha = progress * sa * 0.9;
    ctx.fillStyle = i % 2 === 0 ? '#fff' : '#ff4d8d';
    ctx.save();
    ctx.translate(Math.cos(a)*r, Math.sin(a)*r);
    ctx.rotate(a);
    // Small diamond
    ctx.beginPath();
    ctx.moveTo(0,-4); ctx.lineTo(2.5,0); ctx.lineTo(0,4); ctx.lineTo(-2.5,0);
    ctx.closePath(); ctx.fill();
    ctx.restore();
  }

  ctx.restore();
}

function drawAccessory(ctx, acc, t) {
  if (acc==='none') return;
  if (acc==='bow') {
    ctx.fillStyle='#f44336'; ctx.strokeStyle='#b71c1c'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.moveTo(0,-24); ctx.bezierCurveTo(-8,-30,-12,-22,-6,-20); ctx.bezierCurveTo(-2,-18,0,-22,0,-24); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(0,-24); ctx.bezierCurveTo(8,-30,12,-22,6,-20); ctx.bezierCurveTo(2,-18,0,-22,0,-24); ctx.fill(); ctx.stroke();
    ctx.fillStyle='#ffcdd2'; ctx.beginPath(); ctx.arc(0,-24,3,0,Math.PI*2); ctx.fill();
  } else if (acc==='flower') {
    const petals=6;
    for(let i=0;i<petals;i++){
      const a=i/petals*Math.PI*2;
      ctx.fillStyle=i%2===0?'#f48fb1':'#fff';
      ctx.beginPath(); ctx.ellipse(Math.cos(a)*6,Math.sin(a)*6-24,3.5,3.5,a,0,Math.PI*2); ctx.fill();
    }
    ctx.fillStyle='#ffe082'; ctx.beginPath(); ctx.arc(0,-24,3.5,0,Math.PI*2); ctx.fill();
  } else if (acc==='hat') {
    ctx.fillStyle='#212121'; ctx.strokeStyle='#424242'; ctx.lineWidth=1.5;
    ctx.fillRect(-9,-34,18,10); ctx.stroke();
    ctx.fillRect(-12,-35,24,4); ctx.stroke();
    ctx.fillStyle='#f48fb1'; ctx.fillRect(-9,-33,18,3);
  } else if (acc==='stars') {
    const starT = t*0.05;
    [[-10,-24],[10,-24],[0,-28]].forEach(([sx,sy],i)=>{
      const pulse=0.8+Math.sin(starT+i)*0.3;
      ctx.save(); ctx.translate(sx,sy); ctx.scale(pulse,pulse);
      ctx.fillStyle=['#ffd700','#ff6b9d','#64dfdf'][i];
      drawStar(ctx,0,0,4,2);
      ctx.restore();
    });
  } else if (acc==='crown') {
    ctx.fillStyle='#ffd700'; ctx.strokeStyle='#ff8f00'; ctx.lineWidth=1.5;
    ctx.beginPath();
    ctx.moveTo(-10,-26); ctx.lineTo(-10,-34); ctx.lineTo(-6,-30);
    ctx.lineTo(0,-36); ctx.lineTo(6,-30); ctx.lineTo(10,-34); ctx.lineTo(10,-26); ctx.closePath();
    ctx.fill(); ctx.stroke();
    ['#e53935','#1e88e5','#43a047'].forEach((c,i)=>{
      ctx.fillStyle=c; ctx.beginPath(); ctx.arc(-5+i*5,-28,1.8,0,Math.PI*2); ctx.fill();
    });
  }
}

function drawStar(ctx,cx,cy,r1,r2) {
  ctx.beginPath();
  for(let i=0;i<10;i++){
    const a=i/10*Math.PI*2 - Math.PI/2;
    const r=i%2===0?r1:r2;
    i===0?ctx.moveTo(cx+Math.cos(a)*r,cy+Math.sin(a)*r):ctx.lineTo(cx+Math.cos(a)*r,cy+Math.sin(a)*r);
  }
  ctx.closePath(); ctx.fill();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let previewTimer = null;

function updatePreview() {
  clearTimeout(previewTimer);
  previewTimer = setTimeout(()=>{
    renderCatPreview('previewCanvas', 90, 90);
    renderCatPreview('titleCatCanvas', 130, 130);
  }, 16);
}

function renderCatPreview(id, w, h) {
  const c = document.getElementById(id);
  if (!c) return;
  const ctx = c.getContext('2d');
  ctx.clearRect(0,0,w,h);
  drawCatTopDown(ctx, w/2, h/2+8, catCfg, Date.now()*0.016, 0, 0, false);
}

function setCatProp(prop, val) {
  catCfg[prop] = val;
  // Update selected states
  if (prop==='colorIdx') {
    document.querySelectorAll('#color-swatches .swatch').forEach(s=>s.classList.toggle('selected',+s.dataset.idx===val));
  } else if (prop==='eyeIdx') {
    document.querySelectorAll('#eye-swatches .swatch').forEach(s=>s.classList.toggle('selected',+s.dataset.idx===val));
  } else if (prop==='pattern') {
    document.querySelectorAll('#pattern-opts .opt-btn').forEach(s=>s.classList.toggle('selected',s.dataset.val===val));
  } else if (prop==='accessory') {
    document.querySelectorAll('#acc-opts .opt-btn').forEach(s=>s.classList.toggle('selected',s.dataset.val===val));
  }
  updatePreview();
}

function selectDiff(d) {
  difficulty = d;
  document.querySelectorAll('.diff-card').forEach(c=>{
    c.classList.toggle('selected', c.dataset.diff===d);
  });
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));
  const el = document.getElementById(id);
  if (el) el.classList.remove('hidden');
  document.getElementById('hud').style.display='none';
  document.getElementById('game-canvas-wrap').style.display='none';
  if (id==='custom-screen') { updatePreview(); startPreviewAnim(); }
  else stopPreviewAnim();
}

let previewAnimId = null;
function startPreviewAnim() {
  function frame() {
    renderCatPreview('previewCanvas', 90, 90);
    renderCatPreview('titleCatCanvas', 130, 130);
    previewAnimId = requestAnimationFrame(frame);
  }
  stopPreviewAnim();
  previewAnimId = requestAnimationFrame(frame);
}
function stopPreviewAnim() {
  if (previewAnimId) { cancelAnimationFrame(previewAnimId); previewAnimId = null; }
}

function goLevelSelect() {
  catName = document.getElementById('cat-name-input').value.trim() || 'Mochi';
  updateLevelCards();
  showScreen('level-screen');
}

function updateLevelCards() {
  for (let i=0;i<4;i++) {
    const el = document.getElementById('lc-'+i);
    if (!el) continue;
    if (i <= unlockedLevels-1 || i < unlockedLevels) {
      el.classList.remove('locked'); el.classList.add('unlocked');
      el.onclick = ()=>beginLevel(i);
    } else {
      el.classList.add('locked'); el.classList.remove('unlocked');
      el.onclick = null;
    }
  }
  // ensure level 0 always playable
  const el0 = document.getElementById('lc-0');
  if(el0){ el0.classList.remove('locked'); el0.classList.add('unlocked'); el0.onclick=()=>beginLevel(0); }
}

function quickPlay() {
  catName = document.getElementById('cat-name-input')?.value.trim() || 'Mochi';
  updateLevelCards();
  showScreen('level-screen');
}

function retryLevel() { beginLevel(currentLevel); }
function nextLevel() {
  if (currentLevel+1 < 4) beginLevel(currentLevel+1);
  else goLevelSelect();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LEVEL DEFINITIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// World is COLS*TILE wide, rows tall (scrolls upward)
// Each level is a tilemap: 0=floor, 1=wall/solid, 2=elevated platform, 3=water/void
// We generate procedurally using a builder

const LEVEL_DEFS = [
  { name:'Home Sweet Home', icon:'üè†',
    theme:'home', rows:36,
    floorTile:{fill:'#efebe9',alt:'#e8ddd8',line:'#d7ccc8'},
    wallFill:'#bcaaa4', elevFill:'#fff9f0', elevStroke:'#ffb3a0',
    completeTxt:'You found the cat door! üê±üè†',
    dogCount:3,
    collectEmojis:['üêü','ü•õ','üç£','üß∂','ü™Ü'],
  },
  { name:'Neighbourhood Park', icon:'üå≥',
    theme:'park', rows:40,
    floorTile:{fill:'#c8e6c9',alt:'#b2dfdb',line:'#a5d6a7'},
    wallFill:'#388e3c', elevFill:'#e8f5e9', elevStroke:'#66bb6a',
    completeTxt:'You reached the park gate! üå≥üå∏',
    dogCount:4,
    collectEmojis:['üçé','üêü','üå∏','üéæ','üçÇ'],
  },
  { name:'The Big Building', icon:'üè¢',
    theme:'building', rows:44,
    floorTile:{fill:'#cfd8dc',alt:'#b0bec5',line:'#90a4ae'},
    wallFill:'#607d8b', elevFill:'#eceff1', elevStroke:'#78909c',
    completeTxt:'Rooftop reached! üè¢‚ú®',
    dogCount:5,
    collectEmojis:['üç±','ü•´','‚≠ê','üîÆ','üíé'],
  },
  { name:'Train Station', icon:'üöâ',
    theme:'station', rows:48,
    floorTile:{fill:'#d1c4e9',alt:'#b39ddb',line:'#9575cd'},
    wallFill:'#5e35b1', elevFill:'#ede7f6', elevStroke:'#9575cd',
    completeTxt:'All aboard! üöâüéä',
    dogCount:5,
    collectEmojis:['üçô','üçú','üé´','üß∏','üöÑ'],
  },
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORLD GENERATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Tile types: 0=floor, 1=wall, 2=elevated(platform), 3=void/water
function generateWorld(levelIdx) {
  const def = LEVEL_DEFS[levelIdx];
  const R = def.rows, C = COLS;
  // grid[row][col]
  const grid = Array.from({length:R}, ()=>Array(C).fill(0));

  // Border walls
  for(let r=0;r<R;r++){ grid[r][0]=1; grid[r][C-1]=1; }
  // Top wall (before door area)
  for(let c=1;c<C-1;c++) grid[0][c]=1;
  // Bottom wall
  for(let c=0;c<C;c++) grid[R-1][c]=1;

  // Door gap at top center (cols 4-5)
  grid[0][4]=0; grid[0][5]=0;

  // Generate interior obstacles based on theme
  const rng = seededRng(levelIdx * 999 + Date.now() % 1000);

  if (def.theme==='home') {
    // Furniture: sofas, tables as walls; rugs as elevated platforms
    placeRooms(grid, R, C, rng, [
      {type:1,minR:4,maxR:R-4,minC:1,maxC:C-1,count:12,w:2,h:1},  // horizontal furniture
      {type:1,minR:4,maxR:R-4,minC:1,maxC:C-1,count:8,w:1,h:2},   // vertical furniture
      {type:2,minR:6,maxR:R-6,minC:2,maxC:C-2,count:6,w:2,h:2},   // raised rugs/platforms
    ]);
  } else if (def.theme==='park') {
    // Trees as walls, pond as void, benches as elevated
    placeRooms(grid, R, C, rng, [
      {type:1,minR:3,maxR:R-3,minC:1,maxC:C-1,count:14,w:1,h:1},  // trees
      {type:3,minR:8,maxR:R-8,minC:2,maxC:C-2,count:2,w:3,h:3},   // ponds
      {type:2,minR:5,maxR:R-5,minC:2,maxC:C-2,count:7,w:2,h:1},   // benches/stepping stones
    ]);
  } else if (def.theme==='building') {
    placeRooms(grid, R, C, rng, [
      {type:1,minR:3,maxR:R-3,minC:1,maxC:C-1,count:16,w:3,h:1},
      {type:1,minR:3,maxR:R-3,minC:1,maxC:C-1,count:8,w:1,h:2},
      {type:2,minR:5,maxR:R-5,minC:2,maxC:C-2,count:8,w:2,h:1},
    ]);
  } else {
    placeRooms(grid, R, C, rng, [
      {type:1,minR:3,maxR:R-3,minC:1,maxC:C-1,count:14,w:2,h:1},
      {type:3,minR:6,maxR:R-6,minC:1,maxC:C-1,count:3,w:2,h:2},
      {type:2,minR:5,maxR:R-5,minC:2,maxC:C-2,count:8,w:2,h:1},
    ]);
  }

  // Ensure path from bottom to top (flood fill check + carve if needed)
  ensurePath(grid, R, C);

  return grid;
}

function placeRooms(grid, R, C, rng, specs) {
  for(const spec of specs) {
    for(let i=0;i<spec.count;i++) {
      const r = Math.floor(rng()*(spec.maxR-spec.minR)+spec.minR);
      const c = Math.floor(rng()*(spec.maxC-spec.minC-spec.w)+spec.minC);
      // Don't block door corridor (rows 0-2, cols 3-6)
      if(r<=2 && c>=3 && c<=5) continue;
      // Don't block start area (bottom 3 rows)
      if(r>=R-4) continue;
      for(let dr=0;dr<spec.h&&r+dr<R-1;dr++)
        for(let dc=0;dc<spec.w&&c+dc<C-1;dc++)
          if(grid[r+dr][c+dc]===0) grid[r+dr][c+dc]=spec.type;
    }
  }
}

function ensurePath(grid, R, C) {
  // Simple: every 4 rows, guarantee at least one horizontal gap
  for(let r=4;r<R-4;r+=3){
    let hasGap=false;
    for(let c=1;c<COLS-1;c++) if(grid[r][c]===0||grid[r][c]===2) { hasGap=true; break; }
    if(!hasGap) { grid[r][Math.floor(COLS/2)]=0; grid[r][Math.floor(COLS/2)+1]=0; }
  }
}

function seededRng(seed) {
  let s=seed|0;
  return function(){ s=(s*9301+49297)%233280; return s/233280; };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let gs = null;
let raf = null;
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const keys = {};

function beginLevel(idx) {
  currentLevel = idx;
  stopPreviewAnim();
  const def = LEVEL_DEFS[idx];
  const rng = seededRng(idx * 7919 + Date.now() % 10000);
  const grid = generateWorld(idx);
  const R = def.rows;

  // Spawn cat at bottom center
  const catStartX = CW/2;
  const catStartY = R*TILE - TILE*1.5;

  // Collect valid floor positions for spawning items/key/dogs
  const floorCells = [];
  for(let r=2;r<R-2;r++)
    for(let c=1;c<COLS-1;c++)
      if(grid[r][c]===0||grid[r][c]===2) floorCells.push({r,c});

  // Place key in middle third of level, not near start or end
  const keyZone = floorCells.filter(p=>p.r>R*0.25&&p.r<R*0.75);
  const keyCell = keyZone[Math.floor(rng()*keyZone.length)] || {r:Math.floor(R/2),c:Math.floor(COLS/2)};

  // Place collectibles
  const collectibles = [];
  const usedCells = new Set([`${keyCell.r},${keyCell.c}`]);
  const spawnZone = floorCells.filter(p=>p.r>2&&p.r<R-3);
  const count = 28 + idx*4;
  for(let i=0;i<count;i++){
    let cell;
    for(let attempt=0;attempt<20;attempt++){
      cell = spawnZone[Math.floor(rng()*spawnZone.length)];
      if(cell && !usedCells.has(`${cell.r},${cell.c}`)) break;
    }
    if(!cell) continue;
    usedCells.add(`${cell.r},${cell.c}`);
    const roll = rng();
    let type, emoji, pts, en;
    if(roll<0.28){type='food';emoji=def.collectEmojis[0];pts=8;en=22;}
    else if(roll<0.45){type='food';emoji=def.collectEmojis[1]||'üêü';pts=6;en=18;}
    else if(roll<0.58){type='toy';emoji=def.collectEmojis[2]||'üß∂';pts=12;en=0;}
    else if(roll<0.70){type='toy';emoji=def.collectEmojis[3]||'üéæ';pts=15;en=0;}
    else if(roll<0.78){type='toy';emoji=def.collectEmojis[4]||'‚≠ê';pts=18;en=0;}
    else if(roll<0.84){type='toy';emoji=['üåü','üí´','‚ú®'][Math.floor(rng()*3)];pts=20;en=0;}
    else {type='flower';emoji=['üå∏','üåº','üíê'][Math.floor(rng()*3)];pts=3;en=5;}
    // golden mice get movement
    const spd = type==='goldenmouse'?2.2:0;
    const mDir = rng()>0.5?1:-1;
    collectibles.push({
      type,emoji,pts,en,collected:false,
      wx:cell.c*TILE+TILE/2, wy:cell.r*TILE+TILE/2,
      elevated:grid[cell.r][cell.c]===2,
      moveSpeed:spd, moveDir:mDir,
      moveMin:(cell.c-1)*TILE+TILE/2, moveMax:(cell.c+1)*TILE+TILE/2,
      bob:rng()*Math.PI*2,
    });
  }
  // Golden mouse ‚Äî one per level
  {
    const gmZone = floorCells.filter(p=>p.r>R*0.3&&p.r<R*0.7);
    const gmCell = gmZone[Math.floor(rng()*gmZone.length)]||{r:Math.floor(R/2),c:3};
    const spd=2.2+rng()*0.8;
    collectibles.push({
      type:'goldenmouse',emoji:'üê≠',pts:200,en:30,collected:false,
      wx:gmCell.c*TILE+TILE/2, wy:gmCell.r*TILE+TILE/2,
      elevated:false, moveSpeed:spd, moveDir:1,
      moveMin:(gmCell.c-2)*TILE+TILE/2, moveMax:(gmCell.c+2)*TILE+TILE/2,
      bob:0, golden:true,
    });
  }

  // Spawn dogs
  const dogs = [];
  const dogZone = floorCells.filter(p=>p.r>4&&p.r<R-4);
  const dConf = DIFF[difficulty];
  for(let i=0;i<def.dogCount;i++){
    let cell;
    for(let a=0;a<30;a++){
      cell=dogZone[Math.floor(rng()*dogZone.length)];
      if(cell && Math.abs(cell.r*TILE - catStartY)>TILE*4) break;
    }
    if(!cell) continue;
    const breeds=['mutt','terrier','dachshund','bulldog','greyhound'];
    const breed=breeds[Math.floor(rng()*breeds.length)];
    const bInfo=DOG_BREEDS[breed];
    dogs.push({
      breed, ...bInfo,
      wx:cell.c*TILE+TILE/2, wy:cell.r*TILE+TILE/2,
      vx:0, vy:0,
      dir:rng()>0.5?1:-1,
      state:'wander',
      wanderTimer:Math.floor(rng()*120),
      hitsLeft:bInfo.hitsNeeded,
      hitCooldown:0, stunTick:0,
      speed:bInfo.baseSpeed * 0.45 * dConf.dogSpeed * (0.85+rng()*0.3),
    });
  }

  gs = {
    running:true, time:0, score:0, energy:100,
    energyTick:0, hasKey:false, doorOpen:false, doorShake:0,
    camY:0,
    grid, R,
    def,
    cat:{
      wx:catStartX, wy:catStartY,
      vx:0, vy:0,
      facingAngle:Math.PI, // faces up initially
      moving:false,
      scratchTimer:0,   // counts down while animating
      scratchCooldown:0,// counts down before can scratch again
    },
    key:{wx:keyCell.c*TILE+TILE/2, wy:keyCell.r*TILE+TILE/2, pulse:0, collected:false},
    door:{wx:(COLS/2)*TILE, wy:TILE*1.5},  // row 1 center, reachable
    collectibles, dogs,
    particles:[],
    joystick:{active:false,dx:0,dy:0},
  };

  // HUD
  document.getElementById('hud').style.display='block';
  document.getElementById('game-canvas-wrap').style.display='block';
  document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));
  updateDiffBadge();

  if(raf) cancelAnimationFrame(raf);
  gameLoop();
}

const DOG_BREEDS = {
  mutt:     {hitsNeeded:1,baseSpeed:0.7,chaseRange:120,drain:1.0,scale:1.0,bodyColor:'#d7a87a',strokeColor:'#8d6e63'},
  terrier:  {hitsNeeded:1,baseSpeed:1.1,chaseRange:150,drain:0.9,scale:0.85,bodyColor:'#f5f0e8',strokeColor:'#9e9e9e'},
  dachshund:{hitsNeeded:1,baseSpeed:0.75,chaseRange:110,drain:0.8,scale:0.85,bodyColor:'#bf8040',strokeColor:'#6d3a00'},
  bulldog:  {hitsNeeded:2,baseSpeed:0.5,chaseRange:90, drain:1.4,scale:1.35,bodyColor:'#a1887f',strokeColor:'#5d4037'},
  greyhound:{hitsNeeded:1,baseSpeed:1.4,chaseRange:170,drain:1.1,scale:0.9, bodyColor:'#b0bec5',strokeColor:'#607d8b'},
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INPUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('keydown',e=>{
  keys[e.code]=true;
  if(e.code==='Space'&&gs?.running){
    doScratch(); e.preventDefault();
  }
  if(e.code==='Space') e.preventDefault();
});
window.addEventListener('keyup',e=>{ keys[e.code]=false; });

// Joystick
const jZone = document.getElementById('joystick-zone');
const jKnob = document.getElementById('joystick-knob');
let jTouch = null;
const JR = 55; // max radius

jZone.addEventListener('touchstart',e=>{
  e.preventDefault();
  const t=e.changedTouches[0];
  const rect=jZone.getBoundingClientRect();
  jTouch={id:t.identifier, cx:rect.left+rect.width/2, cy:rect.top+rect.height/2};
  updateJoystick(t.clientX,t.clientY);
},{passive:false});
jZone.addEventListener('touchmove',e=>{
  e.preventDefault();
  for(const t of e.changedTouches) if(jTouch&&t.identifier===jTouch.id) updateJoystick(t.clientX,t.clientY);
},{passive:false});
['touchend','touchcancel'].forEach(ev=>jZone.addEventListener(ev,e=>{
  for(const t of e.changedTouches) if(jTouch&&t.identifier===jTouch.id){
    jTouch=null;
    if(gs) gs.joystick={active:false,dx:0,dy:0};
    jKnob.style.transform='translate(-50%,-50%)';
  }
}));

// Canvas tap on right half = scratch (mobile shortcut)
document.getElementById('gameCanvas').addEventListener('touchstart', e=>{
  e.preventDefault();
  const t = e.changedTouches[0];
  const rect = e.target.getBoundingClientRect();
  const relX = t.clientX - rect.left;
  if(relX > rect.width * 0.45 && gs?.running){
    doScratch();
    const jb = document.getElementById('jump-btn');
    jb.classList.add('pressed');
    setTimeout(()=>jb.classList.remove('pressed'), 200);
  }
}, {passive:false});

function updateJoystick(cx,cy){
  if(!jTouch) return;
  let dx=cx-jTouch.cx, dy=cy-jTouch.cy;
  const dist=Math.hypot(dx,dy);
  if(dist>JR){dx=dx/dist*JR;dy=dy/dist*JR;}
  jKnob.style.transform=`translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
  if(gs) gs.joystick={active:true,dx:dx/JR,dy:dy/JR};
}

function onJumpDown(e){ e.preventDefault(); if(gs?.running) doScratch(); document.getElementById('jump-btn').classList.add('pressed'); }
function onJumpUp(e){ e.preventDefault(); document.getElementById('jump-btn').classList.remove('pressed'); }

function doScratch(){
  if(!gs||!gs.running) return;
  const cat=gs.cat;
  if(cat.scratchCooldown>0) return; // still cooling down
  const d=DIFF[difficulty];
  cat.scratchTimer=SCRATCH_DURATION;
  cat.scratchCooldown=SCRATCH_COOLDOWN;
  gs.energy=Math.max(0, gs.energy - d.scratchCost);
  // Hit any dogs in range
  for(const dog of gs.dogs){
    if(dog.state==='gone'||dog.state==='fleeing') continue;
    const dist=Math.hypot(dog.wx-cat.wx, dog.wy-cat.wy);
    if(dist<=SCRATCH_RANGE){
      dog.hitsLeft--;
      if(dog.hitsLeft<=0){
        dog.state='fleeing'; dog.fleeTick=0;
        const pts=dog.breed==='bulldog'?60:30;
        gs.score+=pts;
        spawnPop(dog.wx,dog.wy,dog.breed==='bulldog'?'üí™ +60!':'üêæ +30!','#ce93d8');
        spawnParticles(dog.wx,dog.wy);
      } else {
        dog.stunTick=50; dog.hitCooldown=60;
        spawnPop(dog.wx,dog.wy,'‚ö° One more scratch!','#ffd700');
      }
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function gameLoop(){
  if(!gs||!gs.running){ return; }
  raf=requestAnimationFrame(gameLoop);
  gs.time++;
  update();
  render();
}

function update(){
  const cat=gs.cat;
  const d=DIFF[difficulty];
  const t=gs.time;

  // ‚îÄ‚îÄ Movement input ‚îÄ‚îÄ
  let ix=0,iy=0;
  if(keys['ArrowLeft']||keys['KeyA']) ix-=1;
  if(keys['ArrowRight']||keys['KeyD']) ix+=1;
  if(keys['ArrowUp']||keys['KeyW']) iy-=1;
  if(keys['ArrowDown']||keys['KeyS']) iy+=1;
  if(gs.joystick.active){ ix+=gs.joystick.dx; iy+=gs.joystick.dy; }
  // Normalize
  const len=Math.hypot(ix,iy);
  if(len>1){ix/=len;iy/=len;}
  cat.moving=len>0.1;

  // Apply movement
  cat.wx+=ix*CAT_SPEED; cat.wy+=iy*CAT_SPEED;

  // Facing
  if(cat.moving) cat.facingAngle=Math.atan2(iy,ix)+Math.PI/2;

  // Clamp to world horizontal bounds
  cat.wx=Math.max(TILE*1.2,Math.min(COLS*TILE-TILE*1.2,cat.wx));

  // Scratch cooldown tick
  if(cat.scratchTimer>0) cat.scratchTimer--;
  if(cat.scratchCooldown>0) cat.scratchCooldown--;

  // Tile collision (walls block horizontal movement)
  resolveCollisions(cat);

  // ‚îÄ‚îÄ Camera: follow cat vertically, clamp ‚îÄ‚îÄ
  const targetCamY = cat.wy - CH*0.6;
  gs.camY += (targetCamY - gs.camY) * 0.08;
  gs.camY = Math.max(0, Math.min(gs.R*TILE - CH, gs.camY));

  // ‚îÄ‚îÄ Energy drain ‚îÄ‚îÄ
  gs.energyTick++;
  if(gs.energyTick>=ENERGY_TICK){ gs.energy-=1.2*d.energyRate; gs.energyTick=0; }
  if(gs.energy<=0){
    gs.running=false;
    showGameOver(); return;
  }

  // ‚îÄ‚îÄ Key pickup ‚îÄ‚îÄ
  if(!gs.key.collected){
    const kd=Math.hypot(cat.wx-gs.key.wx, cat.wy-gs.key.wy);
    if(kd<22){
      gs.key.collected=true; gs.hasKey=true;
      gs.score+=50;
      spawnPop(gs.key.wx,gs.key.wy,'üóùÔ∏è Got the key! Find the door!','#ffd700');
      document.getElementById('key-indicator').textContent='üóùÔ∏è ‚úì';
      // Arrow hint pointing up toward door
      setTimeout(()=>spawnPop(gs.cat.wx, gs.cat.wy-40,'‚¨ÜÔ∏è Door is up top!','#66bb6a'), 800);
    }
    gs.key.pulse=t;
  }

  // ‚îÄ‚îÄ Door check ‚îÄ‚îÄ
  if(gs.hasKey){
    const dd=Math.hypot(cat.wx-gs.door.wx, cat.wy-gs.door.wy);
    if(dd<38){ gs.running=false; showLevelComplete(); return; }
  } else {
    const dd=Math.hypot(cat.wx-gs.door.wx, cat.wy-gs.door.wy);
    if(dd<38 && !gs.doorShake){ gs.doorShake=30; spawnPop(gs.door.wx,gs.door.wy,'üîë Need the key!','#ff7043'); }
  }
  if(gs.doorShake>0) gs.doorShake--;

  // ‚îÄ‚îÄ Collectibles ‚îÄ‚îÄ
  for(const c of gs.collectibles){
    if(c.collected) continue;
    // Mouse movement
    if(c.moveSpeed>0){
      c.wx+=c.moveDir*c.moveSpeed;
      if(c.wx<=c.moveMin||c.wx>=c.moveMax) c.moveDir*=-1;
      // flee from cat
      const catDist=Math.hypot(cat.wx-c.wx,cat.wy-c.wy);
      if(catDist<100) { c.moveDir=c.wx<cat.wx?-1:1; c.wx+=c.moveDir*c.moveSpeed*1.5; }
    }
    // Pickup: must be on same Z level (both on ground or cat on platform matching)
    const dist=Math.hypot(cat.wx-c.wx,cat.wy-c.wy);
    if(dist<22){
      c.collected=true;
      gs.score+=c.pts; gs.energy=Math.min(100,gs.energy+c.en);
      const label=c.type==='goldenmouse'?`‚ú® +${c.pts}!`:c.en>0?`+${c.pts} üç£`:`+${c.pts} ‚≠ê`;
      spawnPop(c.wx,c.wy,label,c.type==='goldenmouse'?'#ffd700':c.en>0?'#f48fb1':'#ce93d8');
      spawnParticles(c.wx,c.wy);
    }
  }

  // ‚îÄ‚îÄ Dogs ‚îÄ‚îÄ
  updateDogs();

  updateHUD();
}

function worldToGrid(w){ return Math.floor(m(w)/TILE); }
function m(w){ return w; }
function inBounds(r,c){ return r>=0&&r<gs.R&&c>=0&&c<COLS; }

function resolveCollisions(cat){
  // Check 4 corners of cat (radius ~12)
  const R2=12;
  const dirs=[[R2,0],[-R2,0],[0,R2],[0,-R2],[R2,R2],[-R2,-R2],[R2,-R2],[-R2,R2]];
  for(const[dx,dy] of dirs){
    const gr=worldToGrid(cat.wy+dy);
    const gc=worldToGrid(cat.wx+dx);
    if(!inBounds(gr,gc)) continue;
    const tile=gs.grid[gr][gc];
    const isBlocked = tile===1 || tile===3;
    if(isBlocked){
      // Push cat out
      const tx=gc*TILE, ty=gr*TILE;
      const ocx=cat.wx-dx, ocy=cat.wy-dy;
      // find minimal push
      const overlapX=Math.abs(cat.wx-(tx+TILE/2))-TILE/2-2;
      const overlapY=Math.abs(cat.wy-(ty+TILE/2))-TILE/2-2;
      if(overlapX>overlapY){ cat.wx=ocx; }
      else { cat.wy=ocy; }
    }
  }
  // Also keep cat in world bounds
  cat.wx=Math.max(TILE+R2,Math.min((COLS-1)*TILE-R2,cat.wx));
  cat.wy=Math.max(TILE+R2,Math.min((gs.R-1)*TILE-R2,cat.wy));
}

function updateDogs(){
  const cat=gs.cat;
  const d=DIFF[difficulty];
  for(const dog of gs.dogs){
    if(dog.state==='gone') continue;
    if(dog.stunTick>0){dog.stunTick--;continue;}
    if(dog.hitCooldown>0) dog.hitCooldown--;

    if(dog.state==='fleeing'){
      // run away from cat
      const fx=dog.wx-cat.wx, fy=dog.wy-cat.wy;
      const fl=Math.hypot(fx,fy)||1;
      dog.wx+=fx/fl*dog.speed*2.2;
      dog.wy+=fy/fl*dog.speed*2.2;
      dog.fleeTick=(dog.fleeTick||0)+1;
      if(dog.fleeTick>150||dog.wx<TILE||dog.wx>(COLS-1)*TILE||dog.wy<TILE||dog.wy>(gs.R-1)*TILE)
        dog.state='gone';
      continue;
    }

    const distToCat=Math.hypot(cat.wx-dog.wx,cat.wy-dog.wy);
    const chaseRange=dog.chaseRange*(d.dogSpeed>1.2?1.3:1);

    if(distToCat<chaseRange){
      // Chase cat slowly (cozy!)
      const dx=cat.wx-dog.wx, dy=cat.wy-dog.wy;
      const dl=Math.hypot(dx,dy)||1;
      dog.wx+=dx/dl*dog.speed*0.45;
      dog.wy+=dy/dl*dog.speed*0.45;
    } else {
      // Wander
      dog.wanderTimer--;
      if(dog.wanderTimer<=0){
        dog.wanderAngle=(dog.wanderAngle||0)+((Math.random()-0.5)*Math.PI);
        dog.wanderTimer=90+Math.floor(Math.random()*120);
      }
      const wa=dog.wanderAngle||0;
      dog.wx+=Math.cos(wa)*dog.speed*0.28;
      dog.wy+=Math.sin(wa)*dog.speed*0.28;
    }

    // Clamp dog to world
    dog.wx=Math.max(TILE+10,Math.min((COLS-1)*TILE-10,dog.wx));
    dog.wy=Math.max(TILE+10,Math.min((gs.R-1)*TILE-10,dog.wy));

    // Collision with cat ‚Äî drain energy
    if(distToCat<24&&dog.hitCooldown===0){
      gs.energy-=d.dogDrain*dog.drain;
      dog.hitCooldown=90;
      spawnPop(dog.wx,dog.wy,`üê∂ -${Math.round(d.dogDrain*dog.drain)}!`,'#ef9a9a');
    }
  }
  gs.dogs=gs.dogs.filter(d=>d.state!=='gone');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render(){
  ctx.clearRect(0,0,CW,CH);
  const camY=gs.camY;
  const def=gs.def;

  ctx.save();
  ctx.translate(0,-camY);

  // ‚îÄ‚îÄ Tiles ‚îÄ‚îÄ
  const startR=Math.max(0,Math.floor(camY/TILE)-1);
  const endR=Math.min(gs.R,startR+Math.ceil(CH/TILE)+2);
  for(let r=startR;r<endR;r++){
    for(let c=0;c<COLS;c++){
      const tile=gs.grid[r][c];
      const tx=c*TILE, ty=r*TILE;
      drawTile(tx,ty,tile,def,r,c);
    }
  }

  // ‚îÄ‚îÄ Door ‚îÄ‚îÄ
  drawDoor(gs.door.wx,gs.door.wy,def,gs.hasKey,gs.doorShake,gs.time);

  // ‚îÄ‚îÄ Key ‚îÄ‚îÄ
  if(!gs.key.collected) drawKey(gs.key.wx,gs.key.wy,gs.time);

  // ‚îÄ‚îÄ Collectibles ‚îÄ‚îÄ
  for(const c of gs.collectibles){
    if(c.collected) continue;
    drawCollectible(c,gs.time);
  }

  // ‚îÄ‚îÄ Dogs ‚îÄ‚îÄ
  for(const dog of gs.dogs){
    if(dog.state==='gone') continue;
    drawDogTopDown(dog,gs.time,gs.cat);
  }

  // ‚îÄ‚îÄ Cat ‚îÄ‚îÄ
  drawCatTopDown(ctx, gs.cat.wx, gs.cat.wy,
    catCfg, gs.time, 0, gs.cat.facingAngle, gs.cat.moving, gs.cat.scratchTimer>0);

  // ‚îÄ‚îÄ Scratch effect ‚îÄ‚îÄ
  if(gs.cat.scratchTimer>0) drawScratchEffect(gs.cat, gs.time);

  // ‚îÄ‚îÄ Particles ‚îÄ‚îÄ
  drawParticles();

  ctx.restore();

  // ‚îÄ‚îÄ Progress bar (screen-space) ‚îÄ‚îÄ
  drawProgress();
}

function drawTile(tx,ty,tile,def,r,c){
  const isAlt=(r+c)%2===1;
  if(tile===0){
    ctx.fillStyle=isAlt?def.floorTile.alt:def.floorTile.fill;
    ctx.fillRect(tx,ty,TILE,TILE);
    ctx.strokeStyle=def.floorTile.line; ctx.lineWidth=0.5;
    ctx.strokeRect(tx,ty,TILE,TILE);
  } else if(tile===1){
    // Wall / obstacle
    ctx.fillStyle=def.wallFill;
    ctx.fillRect(tx,ty,TILE,TILE);
    // top highlight
    ctx.fillStyle='rgba(255,255,255,0.18)';
    ctx.fillRect(tx,ty,TILE,4);
    // Draw themed obstacle icon
    ctx.font='20px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    const icons={'home':['üõãÔ∏è','üì¶','ü™ë','üö™'],'park':['üå≥','ü™®','üåø','üå≤'],'building':['üñ•Ô∏è','üìÅ','ü™ë','üóÑÔ∏è'],'station':['üß≥','üóëÔ∏è','üì¶','üõ∫']};
    const themeIcons=icons[def.theme]||['‚¨ú'];
    const iconIdx=((r*COLS+c)*31)%themeIcons.length;
    ctx.globalAlpha=0.7;
    ctx.fillText(themeIcons[iconIdx],tx+TILE/2,ty+TILE/2);
    ctx.globalAlpha=1;
  } else if(tile===2){
    // Elevated platform ‚Äî floor + raised border
    ctx.fillStyle=def.elevFill;
    ctx.fillRect(tx,ty,TILE,TILE);
    ctx.strokeStyle=def.elevStroke; ctx.lineWidth=2.5;
    ctx.strokeRect(tx+1,ty+1,TILE-2,TILE-2);
    // shadow on south/east edges
    ctx.fillStyle='rgba(0,0,0,0.12)';
    ctx.fillRect(tx+3,ty+TILE-4,TILE-3,4);
    ctx.fillRect(tx+TILE-4,ty+3,4,TILE-4);
    // highlight NW
    ctx.fillStyle='rgba(255,255,255,0.3)';
    ctx.fillRect(tx,ty,TILE,3); ctx.fillRect(tx,ty,3,TILE);
  } else if(tile===3){
    // Water/void
    const wt=Date.now()*0.001;
    const baseColors={'home':'#cfd8dc','park':'#81d4fa','building':'#263238','station':'#1a237e'};
    ctx.fillStyle=baseColors[def.theme]||'#90caf9';
    ctx.fillRect(tx,ty,TILE,TILE);
    ctx.globalAlpha=0.3;
    ctx.fillStyle=`rgba(255,255,255,${0.2+Math.sin(wt+r+c)*0.1})`;
    ctx.beginPath(); ctx.ellipse(tx+TILE*0.3,ty+TILE*0.4,8,4,wt+r,0,Math.PI*2); ctx.fill();
    ctx.globalAlpha=1;
  }
}

function drawDoor(wx,wy,def,hasKey,shake,t){
  const x = wx + (shake>0?Math.sin(t*0.8)*(shake/5):0);
  const y = wy;
  const doorColors={
    home:{frame:'#795548',panel:'#8d6e63',knob:'#ffd700'},
    park:{frame:'#388e3c',panel:'#4caf50',knob:'#ffd700'},
    building:{frame:'#455a64',panel:'#607d8b',knob:'#90caf9'},
    station:{frame:'#4527a0',panel:'#5e35b1',knob:'#ffd700'},
  };
  const dc=doorColors[def.theme]||doorColors.home;
  ctx.save();
  ctx.translate(x,y);

  // Door frame
  ctx.fillStyle=dc.frame;
  ctx.fillRect(-20,-28,40,50);
  // Door panel
  ctx.fillStyle=hasKey?'#66bb6a':dc.panel;
  ctx.fillRect(-16,-24,32,44);
  // Panel detail
  ctx.fillStyle='rgba(255,255,255,0.15)';
  ctx.fillRect(-12,-20,12,16); ctx.fillRect(2,-20,12,16);
  ctx.fillRect(-12,-2,12,16); ctx.fillRect(2,-2,12,16);
  // Knob
  ctx.fillStyle=hasKey?'#ffd700':dc.knob;
  ctx.beginPath(); ctx.arc(10,2,4,0,Math.PI*2); ctx.fill();
  // Glow if open
  if(hasKey){
    ctx.save(); ctx.globalAlpha=0.35+Math.sin(t*0.1)*0.15;
    ctx.fillStyle='#a5d6a7';
    ctx.beginPath(); ctx.arc(0,0,28,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }
  // Label
  ctx.font='bold 9px Nunito,sans-serif'; ctx.fillStyle=hasKey?'#2e7d32':'rgba(255,255,255,0.8)';
  ctx.textAlign='center'; ctx.textBaseline='bottom';
  ctx.fillText(hasKey?'OPEN':'üîí LOCKED',0,-30);
  // Arch top
  ctx.fillStyle=dc.frame;
  ctx.beginPath(); ctx.arc(0,-28,20,Math.PI,2*Math.PI); ctx.fill();
  ctx.fillStyle=hasKey?'#a5d6a7':dc.panel;
  ctx.beginPath(); ctx.arc(0,-28,16,Math.PI,2*Math.PI); ctx.fill();

  ctx.restore();
}

function drawKey(wx,wy,t){
  ctx.save();
  ctx.translate(wx,wy);
  const pulse=0.92+Math.sin(t*0.08)*0.08;
  ctx.scale(pulse,pulse);
  // Glowing backdrop circle
  ctx.shadowColor='#ffd700';
  ctx.shadowBlur=14+Math.sin(t*0.1)*8;
  ctx.fillStyle='rgba(255,248,180,0.92)';
  ctx.beginPath(); ctx.arc(0,0,18,0,Math.PI*2); ctx.fill();
  ctx.shadowBlur=0;
  // Border ring
  ctx.strokeStyle='#ffc107'; ctx.lineWidth=2.5;
  ctx.beginPath(); ctx.arc(0,0,18,0,Math.PI*2); ctx.stroke();
  // Key emoji ‚Äî large and clear
  ctx.font='22px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText('üóùÔ∏è',0,1);
  // Orbiting sparkle
  const sa=t*0.05;
  ctx.font='11px serif';
  ctx.fillText('‚ú®',20*Math.sin(sa),-20*Math.cos(sa));
  ctx.restore();
}

function drawCollectible(c,t){
  const bob=Math.sin(t*0.07+c.bob)*3;
  ctx.save();
  ctx.translate(c.wx, c.wy+bob);

  if(c.type==='goldenmouse'||c.golden){
    // Golden mouse ‚Äî bright glowing backdrop
    ctx.shadowColor='#ffd700';
    ctx.shadowBlur=16+Math.sin(t*0.1)*6;
    ctx.fillStyle='rgba(255,248,180,0.95)';
    ctx.beginPath(); ctx.arc(0,0,16,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#ffc107'; ctx.lineWidth=2; ctx.shadowBlur=0;
    ctx.beginPath(); ctx.arc(0,0,16,0,Math.PI*2); ctx.stroke();
    ctx.font='20px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    if(c.moveDir<0){ ctx.save(); ctx.scale(-1,1); ctx.fillText('üê≠',0,1); ctx.restore(); }
    else ctx.fillText('üê≠',0,1);
    ctx.font='10px serif';
    ctx.fillText('‚ú®',-14,-14); ctx.fillText('‚ú®',14,-14);
  } else if(c.type==='food'){
    // Food ‚Äî soft warm backdrop
    ctx.fillStyle='rgba(255,253,240,0.92)';
    ctx.beginPath(); ctx.arc(0,0,15,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(255,179,0,0.55)'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(0,0,15,0,Math.PI*2); ctx.stroke();
    ctx.font='20px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(c.emoji,0,1);
  } else if(c.type==='toy'){
    // Toy ‚Äî soft lavender backdrop
    ctx.fillStyle='rgba(243,229,245,0.92)';
    ctx.beginPath(); ctx.arc(0,0,15,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(206,147,216,0.6)'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(0,0,15,0,Math.PI*2); ctx.stroke();
    ctx.font='20px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(c.emoji,0,1);
  } else {
    // Flower / misc ‚Äî mint backdrop
    ctx.fillStyle='rgba(232,245,233,0.92)';
    ctx.beginPath(); ctx.arc(0,0,14,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(102,187,106,0.5)'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.arc(0,0,14,0,Math.PI*2); ctx.stroke();
    ctx.font='18px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(c.emoji,0,1);
  }
  ctx.restore();
}

function drawDogTopDown(dog,t,cat){
  const col=dog.bodyColor,stroke=dog.strokeColor;
  const s=dog.scale||1;
  const isFleeing=dog.state==='fleeing';
  const isStunned=dog.stunTick>0;
  const legSwing=Math.sin(t*0.22)*9*(isFleeing?2:1);

  // Facing toward cat
  const dx=cat.wx-dog.wx, dy=cat.wy-dog.wy;
  const angle=Math.atan2(dy,dx)+Math.PI/2;

  ctx.save();
  ctx.translate(dog.wx,dog.wy);
  ctx.rotate(angle);
  ctx.scale(s,s);

  if(isStunned&&Math.floor(t/4)%2===0) ctx.globalAlpha=0.4;
  else if(dog.hitCooldown>70&&Math.floor(t/4)%2===0) ctx.globalAlpha=0.55;

  // Shadow
  ctx.fillStyle='rgba(0,0,0,0.06)';
  ctx.beginPath(); ctx.ellipse(0,2,16,7,0,0,Math.PI*2); ctx.fill();

  // Tail
  const tailWag=Math.sin(t*0.18)*(isFleeing?5:20);
  ctx.strokeStyle=col; ctx.lineWidth=5; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(0,12); ctx.quadraticCurveTo(10+tailWag,22,6+tailWag,30); ctx.stroke();

  // Body
  ctx.fillStyle=col; ctx.strokeStyle=stroke; ctx.lineWidth=2;
  if(dog.breed==='bulldog'){
    ctx.beginPath(); ctx.ellipse(0,2,16,12,0,0,Math.PI*2); ctx.fill(); ctx.stroke();
  } else if(dog.breed==='dachshund'){
    ctx.beginPath(); ctx.ellipse(0,2,9,18,0,0,Math.PI*2); ctx.fill(); ctx.stroke();
  } else {
    ctx.beginPath(); ctx.ellipse(0,2,13,13,0,0,Math.PI*2); ctx.fill(); ctx.stroke();
  }

  // Legs
  ctx.strokeStyle=stroke; ctx.lineWidth=5; ctx.lineCap='round';
  const legDist=dog.breed==='bulldog'?14:10;
  [[-legDist,-4+legSwing],[legDist,-4-legSwing],[-legDist,8-legSwing],[legDist,8+legSwing]].forEach(([lx,ly])=>{
    ctx.beginPath(); ctx.moveTo(lx*0.6,ly*0.5); ctx.lineTo(lx,ly); ctx.stroke();
  });

  // Head
  ctx.fillStyle=col; ctx.strokeStyle=stroke; ctx.lineWidth=2;
  const hSize=dog.breed==='bulldog'?11:8;
  ctx.beginPath(); ctx.arc(0,-13,hSize,0,Math.PI*2); ctx.fill(); ctx.stroke();

  // Ears
  ctx.fillStyle=stroke;
  if(dog.breed==='terrier'){
    [[-6,-19],[6,-19]].forEach(([ex,ey])=>{ ctx.beginPath(); ctx.moveTo(ex,ey); ctx.lineTo(ex-3,ey-7); ctx.lineTo(ex+3,ey-7); ctx.closePath(); ctx.fill(); });
  } else {
    [[-7,-14],[7,-14]].forEach(([ex,ey])=>{ ctx.beginPath(); ctx.ellipse(ex,ey,4,6,0,0,Math.PI*2); ctx.fill(); });
  }

  // Eyes
  ctx.fillStyle='#4e342e';
  [[-4,-14],[4,-14]].forEach(([ex,ey])=>{ ctx.beginPath(); ctx.arc(ex,ey,2.5,0,Math.PI*2); ctx.fill(); });
  ctx.fillStyle='white';
  [[-4,-14],[4,-14]].forEach(([ex,ey])=>{ ctx.beginPath(); ctx.arc(ex-0.5,ey-0.5,1,0,Math.PI*2); ctx.fill(); });

  // Nose
  ctx.fillStyle='#5d4037';
  ctx.beginPath(); ctx.arc(0,-10,2.5,0,Math.PI*2); ctx.fill();

  // Panting tongue when chasing
  const distToCat=Math.hypot(cat.wx-dog.wx,cat.wy-dog.wy);
  if(distToCat<dog.chaseRange||isFleeing){
    ctx.fillStyle='#ef9a9a';
    ctx.beginPath(); ctx.ellipse(0,-6,3,5,0,0,Math.PI*2); ctx.fill();
  }

  // ‚ùó when chasing
  if(!isFleeing&&!isStunned&&distToCat<dog.chaseRange){
    ctx.globalAlpha=0.9;
    ctx.font='12px serif'; ctx.textAlign='center';
    ctx.fillText('‚ùó',0,-28/s);
  }

  // üí´ when stunned
  if(isStunned){
    ctx.globalAlpha=0.9; ctx.font='12px serif'; ctx.textAlign='center';
    ctx.fillText('üí´',Math.sin(t*0.3)*5,-30/s);
  }

  // Bulldog hp pips
  if(dog.breed==='bulldog'&&dog.hitsLeft>0&&!isFleeing){
    ctx.globalAlpha=0.9; ctx.font='10px serif'; ctx.textAlign='center';
    for(let h=0;h<dog.hitsLeft;h++) ctx.fillText('‚ù§Ô∏è',-5+h*12,-34/s);
  }

  ctx.restore();
}

function drawParticles(){
  gs.particles=gs.particles.filter(p=>p.life>0);
  for(const p of gs.particles){
    ctx.save(); ctx.globalAlpha=p.life;
    ctx.font=p.size+'px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(p.emoji,p.wx,p.wy);
    ctx.restore();
    p.wx+=p.vx; p.wy+=p.vy; p.vy-=0.1; p.life-=0.025;
  }
}

function drawProgress(){
  const pct=Math.max(0,1-(gs.cat.wy/(gs.R*TILE)));
  const bx=CW-14, by=40, bh=CH-80;
  // Track
  ctx.fillStyle='rgba(255,255,255,0.25)';
  ctx.beginPath(); ctx.roundRect(bx-3,by,6,bh,3); ctx.fill();
  // Fill
  ctx.fillStyle='rgba(244,143,177,0.7)';
  const fillH=bh*pct;
  ctx.beginPath(); ctx.roundRect(bx-3,by+bh-fillH,6,fillH,3); ctx.fill();
  // Cat dot
  ctx.fillStyle='#f48fb1';
  ctx.beginPath(); ctx.arc(bx,by+bh-fillH,5,0,Math.PI*2); ctx.fill();
  // Goal marker
  ctx.font='12px serif'; ctx.textAlign='center';
  ctx.fillText('üèÅ',bx,by+4);
}

function spawnParticles(wx,wy){
  const emojis=['‚ú®','üí´','üå∏','‚≠ê'];
  for(let i=0;i<5;i++){
    gs.particles.push({
      wx,wy, vx:(Math.random()-0.5)*3.5, vy:-2-Math.random()*2.5,
      life:1, size:12+Math.random()*6,
      emoji:emojis[Math.floor(Math.random()*emojis.length)]
    });
  }
}

function spawnPop(wx,wy,text,color){
  const layer=document.getElementById('popup-layer');
  // Convert world pos to screen pos
  const screenX=wx;
  const screenY=wy-gs.camY-30;
  if(screenY<-20||screenY>CH+20) return;
  const el=document.createElement('div');
  el.className='pop';
  el.style.left=Math.max(10,Math.min(CW-80,screenX-30))+'px';
  el.style.top=Math.max(10,screenY)+'px';
  el.style.color=color||'#5d4037';
  el.textContent=text;
  layer.appendChild(el);
  setTimeout(()=>el.remove(),1100);
}

function updateHUD(){
  const pct=Math.max(0,gs.energy)/100;
  const bar=document.getElementById('energy-bar');
  bar.style.width=(pct*100)+'%';
  bar.style.background=pct>.5?'linear-gradient(90deg,#f48fb1,#f06292)':pct>.25?'linear-gradient(90deg,#ffb74d,#ff9800)':'linear-gradient(90deg,#ef9a9a,#e53935)';
  document.getElementById('score-val').textContent=gs.score;
  document.getElementById('key-indicator').textContent=gs.hasKey?'üóùÔ∏è ‚úì':'üóùÔ∏è ‚úó';
  // Scratch button dim when on cooldown
  const jb=document.getElementById('jump-btn');
  if(jb){
    const ready=gs.cat.scratchCooldown<=0;
    jb.style.opacity=ready?'1':'0.45';
    jb.style.transform=ready?'':'scale(0.92)';
  }
}

function updateDiffBadge(){
  const b=document.getElementById('diff-badge-hud');
  b.className=difficulty;
  b.textContent={easy:'üå∏',normal:'‚≠ê',hard:'üî•',paws:'üêæ'}[difficulty];
}

function showGameOver(){
  document.getElementById('go-name').textContent=`${catName} ran out of energy‚Ä¶ üòø`;
  document.getElementById('go-score').textContent=`‚≠ê Score: ${gs.score}`;
  document.getElementById('hud').style.display='none';
  document.getElementById('game-canvas-wrap').style.display='none';
  showScreen('gameover-screen');
}

function showLevelComplete(){
  if(currentLevel+1>unlockedLevels) unlockedLevels=currentLevel+1;
  const def=LEVEL_DEFS[currentLevel];
  document.getElementById('lc-emoji').textContent=def.icon;
  document.getElementById('lc-title').textContent=currentLevel===3?'üéä All Done!':'Level Complete!';
  document.getElementById('lc-desc').textContent=def.completeTxt;
  document.getElementById('lc-score').textContent=`‚≠ê Score: ${gs.score}`;
  const nb=document.getElementById('lc-next-btn');
  nb.style.display=currentLevel<3?'':'none';
  document.getElementById('hud').style.display='none';
  document.getElementById('game-canvas-wrap').style.display='none';
  showScreen('levelcomplete-screen');
  updateLevelCards();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Start preview animation on title
startPreviewAnim();
// Render title cat
renderCatPreview('titleCatCanvas',130,130);
</script>
</body>
</html>
